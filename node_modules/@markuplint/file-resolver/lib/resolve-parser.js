"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.resolveParser = void 0;
const tslib_1 = require("tslib");
const path_1 = tslib_1.__importDefault(require("path"));
const utils_1 = require("./utils");
const parsers = new Map();
async function resolveParser(file, parserConfig, parserOptions) {
    parserConfig = {
        ...parserConfig,
        '/\\.html?$/i': '@markuplint/html-parser',
    };
    parserOptions = parserOptions !== null && parserOptions !== void 0 ? parserOptions : {};
    let parserModName = '@markuplint/html-parser';
    let matched = false;
    for (const pattern of Object.keys(parserConfig)) {
        if (path_1.default.basename(file.path).match((0, utils_1.toRegexp)(pattern))) {
            const modName = parserConfig[pattern];
            if (!modName) {
                continue;
            }
            parserModName = modName;
            matched = true;
            break;
        }
    }
    const parser = await importParser(parserModName);
    return {
        parserModName,
        parser,
        parserOptions,
        matched,
    };
}
exports.resolveParser = resolveParser;
async function importParser(parserModName) {
    const entity = parsers.get(parserModName);
    if (entity) {
        return entity;
    }
    const parser = await Promise.resolve(`${parserModName}`).then(s => tslib_1.__importStar(require(s)));
    return parser;
}
